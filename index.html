<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Derivadas y Límites</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
  <!-- MathJax para fórmulas -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #e0f7f9;
      color: #004d4d;
      padding: 20px;
    }
    h1, h2 {
      color: #007f7f;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      border-radius: 5px;
      border: 1px solid #007f7f;
    }
    button {
      background-color: #00bfbf;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #009999;
    }
    .resultado, .pasos {
      background-color: #ffffff;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      border: 1px solid #007f7f;
      white-space: pre-wrap;
    }
    .resaltado {
      font-weight: bold;
      color: #006666;
    }
    table {
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #007f7f;
      padding: 8px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Calculadora de Derivadas y Límites</h1>
  <label for="funcion">Ingresa una función f(x):</label>
  <input type="text" id="funcion" placeholder="Ej: (3*x^2 + 1)/(x - 2)">
  <button id="btnCalcular">Calcular Derivada</button>

  <div class="resultado" id="respuestaDirecta"></div>
  <div class="pasos" id="pasosDerivada"></div>
  <div class="pasos" id="pasosLimite"></div>
  <div class="resultado" id="tablaValores"></div>
  <div id="grafica"></div>

  <script>
    // Función para convertir nodo mathjs a LaTeX
    function nodeToLatex(node) {
      try {
        return node ? node.toTex({ parenthesis: 'keep', implicit: 'show' }) : '';
      } catch {
        return node ? node.toString() : '';
      }
    }

    // Función recursiva para mostrar paso a paso la derivada general
    function pasoAPasoGeneral(node, derivadaNode) {
      let html = <p><strong>Paso a paso de la derivada</strong>:</p>;
      html += <p>Dada la función \\( f(x) = ${nodeToLatex(node)} \\):</p>;
      html += <ol>;

      function pasosRecursivo(n, nivel = 0) {
        if (n.type === 'OperatorNode') {
          switch (n.op) {
            case '+':
            case '-':
              html += `<li>${nivel === 0 ? 'Identificamos suma/resta:' : 'Regla de la suma/resta:'}<br>
              \\( f(x) = ${nodeToLatex(n.args[0])} ${n.op} ${nodeToLatex(n.args[1])} \\)</li>`;
              html += <ul><li>Derivamos cada término por separado:</li>;
              const respuestaArgs = n.args.map(arg => math.derivative(arg, 'x'));
              n.args.forEach((arg, i) => {
                html += <li>\\( \\frac{d}{dx} ${nodeToLatex(arg)} = ${nodeToLatex(respuestaArgs[i])} \\)</li>;
              });
              html += </ul>;
              break;
            case '*':
              html += <li>Regla del producto:<br>\\( f(x) = ${nodeToLatex(n.args[0])} \\cdot ${nodeToLatex(n.args[1])} \\)</li>;
              html += `<ul>
                  <li>\\( (uv)' = u'v + uv' \\)</li>
                  <li>\\( u = ${nodeToLatex(n.args[0])}, \\, v = ${nodeToLatex(n.args[1])} \\)</li>
                  <li>\\( u' = ${nodeToLatex(math.derivative(n.args[0],'x'))}, \\, v' = ${nodeToLatex(math.derivative(n.args[1],'x'))} \\)</li>
                  <li>\\( f'(x) = u'v + uv' = ${nodeToLatex(math.derivative(n.args[0],'x'))} \\cdot ${nodeToLatex(n.args[1])} + ${nodeToLatex(n.args[0])} \\cdot ${nodeToLatex(math.derivative(n.args[1],'x'))} \\)</li>
                </ul>`;
              break;
            case '/':
              html += <li>Regla del cociente:<br>\\( f(x) = \\frac{${nodeToLatex(n.args[0])}}{${nodeToLatex(n.args[1])}} \\)</li>;
              html += `<ul>
                  <li>\\( \\left(\\frac{u}{v}\\right)' = \\frac{u'v - uv'}{v^{2}} \\)</li>
                  <li>\\( u = ${nodeToLatex(n.args[0])}, \\, v = ${nodeToLatex(n.args[1])} \\)</li>
                  <li>\\( u' = ${nodeToLatex(math.derivative(n.args[0],'x'))}, \\, v' = ${nodeToLatex(math.derivative(n.args[1],'x'))} \\)</li>
                  <li>\\( f'(x) = \\frac{${nodeToLatex(math.derivative(n.args[0],'x'))} \\cdot ${nodeToLatex(n.args[1])} - ${nodeToLatex(n.args[0])} \\cdot ${nodeToLatex(math.derivative(n.args[1],'x'))}}{(${nodeToLatex(n.args[1])})^2} \\)</li>
                </ul>`;
              break;
            case '^':
              html += <li>Regla de la potencia:<br>\\( f(x) = ${nodeToLatex(n)} \\)</li>;
              html += `<ul>
                  <li>Si la base es \\( x \\): \\( (x^n)' = n x^{n-1} \\)</li>
                  <li>\\( f'(x) = ${nodeToLatex(derivadaNode)} \\)</li>
                </ul>`;
              break;
            default:
              html += <li>No se detectó una regla especial para este operador.</li>;
          }
          n.args.forEach(arg => pasosRecursivo(arg, nivel + 1));
        } else if (n.type === 'FunctionNode') {
          html += <li>Derivada de función <strong>${n.fn.name}</strong>:<br>\\( f(x) = ${nodeToLatex(n)} \\)</li>;
          html += <ul><li>Usamos la regla correspondiente (por ejemplo: seno, coseno, logaritmo, etc.).</li></ul>;
        } else if (n.type === 'SymbolNode' || n.type === 'ConstantNode') {
          html += `<li>Derivada de \\( ${nodeToLatex(n)} \\): `;
          html += n.type === 'SymbolNode' ? \\( 1 \\) : \\( 0 \\);
          html += </li>;
        }
      }

      pasosRecursivo(node);

      html += <li><strong>Resultado final simplificado:</strong><br>\\( f'(x) = ${nodeToLatex(derivadaNode)} \\)</li>;
      html += </ol>;
      return html;
    }

    function calcularDerivada() {
      const exprInput = document.getElementById("funcion").value.trim();
      if (!exprInput) {
        alert("Por favor, ingresa una función válida.");
        return;
      }

      let fNode;
      try {
        fNode = math.parse(exprInput);
      } catch {
        alert("Función inválida. Revisa la sintaxis.");
        return;
      }

      let derivadaNode;
      try {
        derivadaNode = math.derivative(fNode, 'x');
      } catch {
        alert("Error al calcular la derivada.");
        return;
      }

      // Mostrar respuesta directa con LaTeX
      document.getElementById("respuestaDirecta").innerHTML =
        `<h2>Respuesta directa</h2>
         <p>La derivada de \\( f(x) = ${nodeToLatex(fNode)} \\) es:</p>
         <p class="resaltado">\\[ f'(x) = ${nodeToLatex(derivadaNode)} \\]</p>`;
      MathJax.typesetPromise();

      // Procedimiento paso a paso para cualquier función
      let pasosHTML = '<h2>Procedimiento paso a paso</h2>';
      pasosHTML += pasoAPasoGeneral(fNode, derivadaNode);

      document.getElementById("pasosDerivada").innerHTML = pasosHTML;
      MathJax.typesetPromise();

      // Procedimiento con definición de límite (simplificado)
      const pasosLim = [];
      pasosLim.push("<h2>Cálculo de la derivada con la definición de límite</h2>");
      pasosLim.push("<p><strong>Fórmula aplicada:</strong> <span class='resaltado'>\\[ f'(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h} \\]</span></p>");

      function replaceXwithXplusH(str) {
        // Reemplaza solo variables x aisladas, no parte de otras variables
        return str.replace(/\bx\b/g, '(x+h)');
      }

      const exprXplusH = replaceXwithXplusH(exprInput);
      let f_xh_str = '';
      try {
        f_xh_str = math.simplify(exprXplusH).toString();
      } catch {
        f_xh_str = exprXplusH;
      }

      let f_x_str = '';
      try {
        f_x_str = math.simplify(exprInput).toString();
      } catch {
        f_x_str = exprInput;
      }

      pasosLim.push(<p><strong>Paso 1:</strong> \\( f(x+h) = ${f_xh_str} \\)</p>);
      pasosLim.push(<p><strong>Paso 2:</strong> \\( f(x) = ${f_x_str} \\)</p>);
      pasosLim.push(<p><strong>Paso 3:</strong> \\( f(x+h) - f(x) = (${f_xh_str}) - (${f_x_str}) \\)</p>);
      pasosLim.push(<p><strong>Paso 4:</strong> \\( \\frac{f(x+h) - f(x)}{h} = \\frac{(${f_xh_str}) - (${f_x_str})}{h} \\)</p>);
      pasosLim.push(<p><strong>Paso 5:</strong> Simplificamos la expresión.</p>);
      pasosLim.push(<p><strong>Paso 6:</strong> Evaluamos el límite cuando \\( h \\to 0 \\).</p>);
      pasosLim.push(<p><strong>Paso 7:</strong> Obtenemos el resultado simbólico.</p>);
      pasosLim.push(<p><strong>Paso 8:</strong> Resultado final: <span class='resaltado'>\\( f'(x) = ${nodeToLatex(derivadaNode)} \\)</span></p>);

      document.getElementById("pasosLimite").innerHTML = pasosLim.join('');
      MathJax.typesetPromise();

      // Tabla de valores
      let tablaHTML = "<h2>Tabla de valores para f(x)</h2><table><tr><th>x</th><th>f(x)</th></tr>";
      for (let i = -5; i <= 5; i++) {
        try {
          const val = math.evaluate(exprInput, { x: i });
          tablaHTML += <tr><td>${i}</td><td>${val.toFixed(4)}</td></tr>;
        } catch (e) {
          tablaHTML += <tr><td>${i}</td><td>Indefinido</td></tr>;
        }
      }
      tablaHTML += "</table>";
      document.getElementById("tablaValores").innerHTML = tablaHTML;

      // Gráfica
      const xValues = math.range(-10, 10, 0.1).toArray();
      const yValues = xValues.map(x => {
        try {
          return math.evaluate(exprInput, { x });
        } catch {
          return null;
        }
      });
      const trace = {
        x: xValues,
        y: yValues,
        mode: 'lines',
        name: 'f(x)',
        line: { color: '#00bfbf' }
      };
      Plotly.newPlot('grafica', [trace], { title: 'Gráfica de f(x)' });
    }

    document.getElementById('btnCalcular').addEventListener('click', calcularDerivada);
  </script>
</body>
</html>
