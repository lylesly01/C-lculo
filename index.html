// Paso 1: f(x)
const fx = math.parse(entrada);
const fx_str = fx.toString();

// Paso 2: f(x + h)
const fxh = fx.transform(node =>
  node.isSymbolNode && node.name === "x"
    ? math.parse("(x + h)")
    : node
);
const fxh_str = fxh.toString();

// Paso 3: f(x + h) - f(x)
const diferencia = math.simplify(`${fxh_str} - (${fx_str})`);
const diferencia_str = diferencia.toString();

// Paso 4: (f(x + h) - f(x)) / h
const cociente = math.simplify(`${diferencia_str} / h`);
const cociente_str = cociente.toString();

// Paso 5: Límite cuando h → 0 (derivada simbólica)
const derivada_str = math.derivative(entrada, "x").toString();

// Mostrando los pasos
resultado.innerHTML += `
  <div class="paso">
    1️⃣ Fórmula general:<br>
    f'(x) = lim₍ₕ→0₎ [f(x+h) – f(x)] / h
  </div>
  <div class="paso">
    2️⃣ f(x) = <strong>${fx_str}</strong>
  </div>
  <div class="paso">
    3️⃣ f(x+h) = <strong>${fxh_str}</strong>
  </div>
  <div class="paso">
    4️⃣ Diferencia: f(x+h) – f(x) = <strong>${diferencia_str}</strong>
  </div>
  <div class="paso">
    5️⃣ Cociente: [f(x+h) – f(x)] / h = <strong>${cociente_str}</strong>
  </div>
  <div class="paso">
    6️⃣ Derivada (límite cuando h→0): f'(x) = <strong>${derivada_str}</strong> ✅
  </div>
`;

// –––––––– Agregando la gráfica ––––––––

// Compilando f(x) y f'(x)
const f = math.compile(entrada);
const df = math.compile(derivada_str);

// Generando datos para el gráfico
const xs = math.range(-10, 10, 0.5).toArray();
const ys = xs.map(x => f.evaluate({ x }));
const dys = xs.map(x => df.evaluate({ x }));

// Incluye en tu HTML un <canvas> con id="grafica", y asegúrate de importar Chart.js:

/*
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<canvas id="grafica"></canvas>
*/

// Inicializando el gráfico:
const ctx = document.getElementById("grafica").getContext("2d");
new Chart(ctx, {
  type: 'line',
  data: {
    labels: xs,
    datasets: [
      {
        label: 'f(x)',
        data: ys,
        borderColor: 'blue',
        fill: false
      },
      {
        label: "f'(x)",
        data: dys,
        borderColor: 'red',
        fill: false
      }
    ]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { position: 'top' }
    },
    scales: {
      x: { type: 'linear', title: { display: true, text: 'x' } },
      y: { title: { display: true, text: 'y' } }
    }
  }
});
